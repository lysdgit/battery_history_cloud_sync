<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>è®¾å¤‡ç”µé‡å†å²æŸ¥è¯¢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: "Microsoft YaHei", Arial, sans-serif;
      margin: 0;
      background-color: #f5f6fa;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      background-color: #4285f4;
      color: white;
      padding: 14px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      overflow-y: auto;
    }
    .query-box {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-bottom: 12px;
    }
    input, button, label {
      font-size: 16px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
    }
    button {
      background-color: #4285f4;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #3367d6;
    }
    #status {
      text-align: center;
      font-size: 15px;
      margin-bottom: 8px;
      color: #444;
    }
    #latest {
      text-align: center;
      font-size: 16px;
      color: #2e7d32;
      margin-bottom: 8px;
      font-weight: bold;
    }
    #chartContainer {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .toggle-box {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }
    .toggle-box input {
      transform: scale(1.2);
    }
  </style>
</head>
<body>
  <header>ğŸ“Š ç”µé‡å†å²æŸ¥è¯¢</header>
  <main>
    <div class="query-box">
      <input id="deviceInput" type="text" placeholder="è®¾å¤‡å (8ä½å­—æ¯æ•°å­—)" maxlength="8" />
      <input id="dateInput" type="date" />
      <button id="btnQuery">æŸ¥è¯¢</button>
    </div>
    <div class="toggle-box">
      <input type="checkbox" id="fixedScale" />
      <label for="fixedScale">å›ºå®šæ»¡åˆ»åº¦ï¼ˆ0~100ï¼‰</label>
    </div>
    <div id="status">çŠ¶æ€ï¼šç­‰å¾…æŸ¥è¯¢</div>
    <div id="latest">æœ€æ–°æ•°æ®ï¼š--</div>
    <div id="chartContainer">
      <canvas id="batteryChart"></canvas>
    </div>
  </main>

  <script>
    const btnQuery = document.getElementById('btnQuery');
    const deviceInput = document.getElementById('deviceInput');
    const dateInput = document.getElementById('dateInput');
    const fixedScale = document.getElementById('fixedScale');
    const statusDiv = document.getElementById('status');
    const latestDiv = document.getElementById('latest');
    const ctx = document.getElementById('batteryChart').getContext('2d');

    // é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const today = new Date().toISOString().slice(0, 10);
    dateInput.value = today;

    // åˆå§‹åŒ–å›¾è¡¨
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'ç”µé‡ (%)',
          data: [],
          borderColor: '#4285f4',
          tension: 0.25,
          fill: false,
          pointRadius: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
        },
        scales: {
          y: {
            min: 0,
            max: 100,
            title: { display: true, text: 'ç”µé‡ (%)' },
            ticks: { stepSize: 20 }
          },
          x: {
            title: { display: true, text: 'æ—¶é—´' },
            ticks: { maxTicksLimit: 8 }
          }
        }
      }
    });

    function validTableName(name) {
      return /^[a-z\d]{8}$/.test(name) && /[a-z]/.test(name) && /\d/.test(name);
    }

    async function fetchHistory(table, date) {
      try {
        const resp = await fetch(`/api/data?table=${encodeURIComponent(table)}&date=${encodeURIComponent(date)}`);
        const json = await resp.json();
        if (!resp.ok || json.error) {
          statusDiv.textContent = `é”™è¯¯: ${json.error || resp.statusText}`;
          latestDiv.textContent = "æœ€æ–°æ•°æ®ï¼š--";
          return;
        }

        const data = json.data || [];
        if (data.length === 0) {
          statusDiv.textContent = "æ²¡æœ‰æ•°æ®";
          latestDiv.textContent = "æœ€æ–°æ•°æ®ï¼š--";
          chart.data.labels = [];
          chart.data.datasets[0].data = [];
          chart.update();
          return;
        }

        // âœ… æ ¹æ®ç”¨æˆ·å¼€å…³åŠ¨æ€è°ƒæ•´Yè½´èŒƒå›´
        if (fixedScale.checked) {
          chart.options.scales.y.min = 0;
          chart.options.scales.y.max = 100;
        } else {
          chart.options.scales.y.min = json.min_battery ?? 0;
          chart.options.scales.y.max = json.max_battery ?? 100;
        }

        chart.data.labels = data.map(d => d.time);
        chart.data.datasets[0].data = data.map(d => d.battery);
        chart.update();

        const latest = data[data.length - 1];
        latestDiv.textContent = `æœ€æ–°æ•°æ®ï¼š${latest.time} â†’ ${latest.battery}%`;
        statusDiv.textContent = `å…± ${data.length} æ¡è®°å½• (èŒƒå›´ ${json.min_battery}~${json.max_battery}%)`;
      } catch (e) {
        statusDiv.textContent = `è¯·æ±‚å¤±è´¥: ${e.message}`;
        latestDiv.textContent = "æœ€æ–°æ•°æ®ï¼š--";
      }
    }

    btnQuery.addEventListener('click', () => {
      const table = deviceInput.value.trim();
      const date = dateInput.value;
      if (!validTableName(table)) {
        alert('è®¾å¤‡åå¿…é¡»ä¸º8ä½ï¼Œå°å†™å­—æ¯å’Œæ•°å­—ç»„æˆï¼Œä¸”è‡³å°‘åŒ…å«ä¸€ä¸ªå­—æ¯å’Œæ•°å­—ã€‚');
        return;
      }
      if (!date) {
        alert('è¯·é€‰æ‹©æ—¥æœŸ');
        return;
      }
      statusDiv.textContent = `æ­£åœ¨æŸ¥è¯¢ ${table} (${date})...`;
      latestDiv.textContent = "æœ€æ–°æ•°æ®ï¼š--";
      fetchHistory(table, date);
    });
  </script>
</body>
</html>
